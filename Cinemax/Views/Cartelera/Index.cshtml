@model Cinemax.ViewModels.CarteleraViewModel

@{
    ViewBag.Title = "Cartelera";
    Layout = "~/Views/Shared/_LayoutCliente.cshtml";
    var fechaSeleccionada = ViewBag.FechaSeleccionada as DateTime?;
    var fechaInputValue = (fechaSeleccionada ?? DateTime.Today).ToString("yyyy-MM-dd");
    var generoSeleccionado = ViewBag.GeneroSeleccionado as string;
}
<style>
    .card:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
        transition: all 0.2s ease;
    }

    .object-fit-cover {
        object-fit: cover;
    }

    .text-truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<!-- Flatpickr CSS & JS desde CDN -->
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h2 class="fw-bold d-flex align-items-center mb-2 mb-md-0">
            <i class="bi bi-film fs-4 me-2 text-primary"></i>
            🎬 Cartelera de películas - @(fechaSeleccionada?.ToString("dd/MM/yyyy") ?? "Fecha no disponible")
        </h2>
    </div>

    <!-- Filtros: Géneros + Fecha -->
    <form method="get" class="mb-4">
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <a href="@Url.Action("Index", "Cartelera", new { genero = "", fecha = fechaSeleccionada?.ToString("yyyy-MM-dd") })"
               class="btn rounded-pill @(string.IsNullOrEmpty(generoSeleccionado) ? "btn-primary text-white" : "btn-outline-secondary")">Todos</a>

            @foreach (var g in ViewBag.Generos as List<string>)
            {
                <a href="@Url.Action("Index", "Cartelera", new { genero = g, fecha = fechaSeleccionada?.ToString("yyyy-MM-dd") })"
                   class="btn rounded-pill @(generoSeleccionado == g ? "btn-primary text-white" : "btn-outline-secondary")">@g</a>
            }
            <!-- Selector de fecha en botón visual -->
            <div style="position: relative;">
                <button type="button" id="btnCalendario"
                        class="btn btn-light rounded-pill d-flex align-items-center justify-content-center"
                        style="width: 44px; height: 44px;">
                    <iconify-icon icon="mdi:calendar-month" width="24" height="24"></iconify-icon>
                </button>

                <!-- Input que Flatpickr usa, pero no se ve -->
                <input type="text"
                       id="fechaSelector"
                       name="fecha"
                       class="d-none"
                       value="@fechaInputValue?.ToString(" yyyy-MM-dd")" />
            </div>




        </div>
    </form>

    <!-- Tarjetas de películas -->
    <div class="row">
        @foreach (var f in Model.Funciones)
        {
            <div class="col-md-6 mb-4">
                <a href="@Url.Action("Detalles", "Funciones", new { id = f.ID_Funcion })" class="text-decoration-none text-dark">
                    <div class="card flex-row shadow-sm border-0 rounded-4 overflow-hidden h-100" style="min-height: 220px;">
                        <!-- Imagen izquierda -->
                        <div class="col-4 p-0">
                            <img src="@f.Pelicula.PEL_ImagenURL"
                                 alt="@f.Pelicula.PEL_Titulo"
                                 class="img-fluid h-100 w-100 object-fit-cover"
                                 style="object-fit: cover;">
                        </div>

                        <!-- Contenido derecho -->
                        <div class="col-8 d-flex flex-column justify-content-between p-3">
                            <!-- Título y sinopsis -->
                            <div>
                                <h5 class="fw-semibold text-dark mb-1" title="@f.Pelicula.PEL_Titulo">@f.Pelicula.PEL_Titulo</h5>
                                <p class="text-dark small mb-3" style="max-height: 40px; overflow: hidden;">
                                    @f.Pelicula.PEL_Sinopsis
                                </p>
                                
                            </div>

                            


                            <!-- Detalles (verticales con separación) -->
                            <div class="text-dark small mb-3">
                                <div class="mb-4"><strong>Hora:</strong> @f.FUN_Fechahora.ToString("hh:mm tt")</div>
                                <div class="mb-4"><strong>Duración:</strong> @f.Pelicula.PEL_Duracion.ToString(@"hh\:mm") min</div>
                                <div class="mb-4"><strong>Sala:</strong> @f.Sala.SAL_Nombre</div>
                                <div><strong>Precio:</strong> $@f.FUN_Precio.ToString("F2")</div>
                            </div>


                            <!-- Enlace -->
                            <div class="mt-auto">
                                <span class="text-primary small fw-semibold">Ver detalles →</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>



        }
    </div>


    <!-- Paginación -->
    <div class="d-flex justify-content-center mt-3">
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-lg gap-2 flex-wrap justify-content-center">
                @if (Model.PaginaActual > 1)
                {
                    <li class="page-item">
                        <a class="page-link px-3" href="@Url.Action("Index", new { pagina = 1, genero = generoSeleccionado, fecha = fechaSeleccionada?.ToString("yyyy-MM-dd") })">Primera</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link px-3" href="@Url.Action("Index", new { pagina = Model.PaginaActual - 1, genero = generoSeleccionado, fecha = fechaSeleccionada?.ToString("yyyy-MM-dd") })">
                            <iconify-icon icon="mdi:chevron-left"></iconify-icon>
                        </a>
                    </li>
                }

                @{
                    int totalPaginas = Model.TotalPaginas;
                    int paginaActual = Model.PaginaActual;
                    int rango = 2;
                    int desde = Math.Max(1, paginaActual - rango);
                    int hasta = Math.Min(totalPaginas, paginaActual + rango);

                    if (desde > 1)
                    {
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    }

                    for (int i = desde; i <= hasta; i++)
                    {
                        <li class="page-item @(i == paginaActual ? "active" : "")">
                            <a class="page-link px-3 @(i == paginaActual ? "bg-primary text-white border-0" : "")"
                               href="@Url.Action("Index", new { pagina = i, genero = generoSeleccionado, fecha = fechaSeleccionada?.ToString("yyyy-MM-dd") })">
                                @i
                            </a>
                        </li>
                    }

                    if (hasta < totalPaginas)
                    {
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    }
                }

                @if (Model.PaginaActual < Model.TotalPaginas)
                {
                    <li class="page-item">
                        <a class="page-link px-3" href="@Url.Action("Index", new { pagina = Model.PaginaActual + 1, genero = generoSeleccionado, fecha = fechaSeleccionada?.ToString("yyyy-MM-dd") })">
                            <iconify-icon icon="mdi:chevron-right"></iconify-icon>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link px-3" href="@Url.Action("Index", new { pagina = Model.TotalPaginas, genero = generoSeleccionado, fecha = fechaSeleccionada?.ToString("yyyy-MM-dd") })">Última</a>
                    </li>
                }
            </ul>
        </nav>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("fechaSelector");
        const trigger = document.getElementById("btnCalendario");

        if (!input || !trigger) return;

        const flat = flatpickr(input, {
            dateFormat: "Y-m-d",
            defaultDate: input.value || new Date(),
            onChange: function (selectedDates, dateStr) {
                const genero = new URLSearchParams(window.location.search).get("genero") || "";
                const url = `@Url.Action("Index", "Cartelera")?fecha=${dateStr}&genero=${genero}`;
                window.location.href = url;
            },
            appendTo: trigger.parentElement
        });

        trigger.addEventListener("click", function () {
            flat.open();
        });
    });
</script>
